[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisor.pid
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[program:nginx]
command=nginx -g 'daemon off;'
autostart=true
autorestart=true
priority=100
stderr_logfile=/var/log/supervisor/nginx.err.log
stdout_logfile=/var/log/supervisor/nginx.out.log
logfile_maxbytes=50MB
logfile_backups=10
startsecs=5
startretries=3

[program:backend]
command=/app/pansou
directory=/app
autostart=true
autorestart=true
priority=200
stderr_logfile=/var/log/supervisor/backend.err.log
stdout_logfile=/var/log/supervisor/backend.out.log
logfile_maxbytes=50MB
logfile_backups=10
environment=PORT=8888,CACHE_PATH=/app/cache
startsecs=10
startretries=3

[program:healthcheck]
command=sh -c 'echo "Starting health check service..." && sleep 15 && while true; do echo "$(date): Running health checks..." && curl -f http://localhost:3000/health > /dev/null 2>&1 && echo "$(date): Frontend OK" || echo "$(date): Frontend FAILED" && curl -f http://localhost:8888/api/health > /dev/null 2>&1 && echo "$(date): Backend OK" || echo "$(date): Backend FAILED" && sleep 30; done'
autostart=true
autorestart=true
priority=300
stderr_logfile=/var/log/supervisor/healthcheck.err.log
stdout_logfile=/var/log/supervisor/healthcheck.out.log
logfile_maxbytes=10MB
logfile_backups=5
startsecs=5
startretries=3
