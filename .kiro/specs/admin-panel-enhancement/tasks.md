# 实现计划：后台管理面板增强

## 概述

本实现计划将后台管理面板增强功能分解为可执行的开发任务。任务按照前端组件、后端 API、集成和测试的顺序组织。

## 任务

- [x] 1. 后端 API 实现
  - [x] 1.1 扩展 APIKeyService - 添加更新和批量操作方法
    - 在 `backend/service/apikey_service.go` 中实现 `UpdateKeyExpiry` 方法
    - 实现 `BatchExtendKeys` 方法
    - 实现 `BatchGenerateKeys` 方法
    - 确保所有方法都有适当的错误处理和并发安全
    - _需求: 5.1, 5.2, 5.3, 5.7_

  - [ ]* 1.2 编写 APIKeyService 单元测试
    - 测试 `UpdateKeyExpiry` 的正常情况和边界情况
    - 测试 `BatchExtendKeys` 的部分成功场景
    - 测试 `BatchGenerateKeys` 的数量限制
    - 测试并发安全性
    - _需求: 5.5, 5.7_

  - [x] 1.3 实现管理员 API 处理器
    - 在 `backend/api/admin_handler.go` 中实现 `UpdateAPIKeyHandler`
    - 实现 `BatchExtendAPIKeysHandler`
    - 实现 `BatchCreateAPIKeysHandler`
    - 添加请求参数验证
    - 添加权限验证
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 1.4 编写 API 处理器单元测试
    - 测试参数验证逻辑
    - 测试权限验证
    - 测试错误响应格式
    - _需求: 5.4, 5.5, 5.6_

  - [x] 1.5 更新路由配置
    - 在 `backend/api/router.go` 中添加新的 API 路由
    - 确保所有新路由都在管理员中间件保护下
    - _需求: 5.1, 5.2, 5.3_

  - [x] 1.6 更新 API 文档
    - 在 `docs/api_reference.md` 中添加新 API 接口文档
    - 包含请求/响应示例
    - 包含错误码说明
    - _需求: 5.1, 5.2, 5.3_

- [x] 2. 检查点 - 后端 API 测试
  - 使用 Postman 或 curl 测试所有新增 API 接口
  - 验证权限控制是否正常工作
  - 验证数据持久化是否正确
  - 确保所有测试通过，询问用户是否有问题

- [x] 3. 前端基础组件实现
  - [x] 3.1 创建 Sidebar 组件
    - 创建 `frontend/src/components/admin/Sidebar.tsx`
    - 实现导航项列表渲染
    - 实现当前选中项高亮
    - 实现移动端折叠/展开功能
    - 添加响应式样式
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 3.2 编写 Sidebar 组件测试
    - **属性 1: 侧边栏导航状态一致性**
    - **验证: 需求 1.3, 1.4**
    - _需求: 1.3, 1.4_

  - [x] 3.3 重构 Admin 页面布局
    - 修改 `frontend/src/pages/Admin.tsx`
    - 集成 Sidebar 组件
    - 实现视图切换逻辑（API Keys / Plugins）
    - 使用 flexbox 布局实现侧边栏和内容区域
    - _需求: 1.1, 1.3_

  - [x] 3.4 创建 BatchActionsBar 组件
    - 创建 `frontend/src/components/admin/BatchActionsBar.tsx`
    - 显示选中数量
    - 实现批量延长按钮
    - 实现清除选择按钮
    - _需求: 3.3, 3.4_

  - [ ]* 3.5 编写 BatchActionsBar 组件测试
    - **属性 5: 选择状态同步**
    - **验证: 需求 3.3, 3.6**
    - _需求: 3.3_

- [x] 4. API Key 表格增强
  - [x] 4.1 添加复选框列
    - 在 API Key 表格中添加复选框列
    - 实现全选/取消全选功能
    - 实现单个选择功能
    - 管理选中状态（使用 useState）
    - _需求: 3.1, 3.2_

  - [x] 4.2 添加编辑按钮
    - 在操作列添加编辑按钮
    - 实现点击事件处理
    - _需求: 2.1_

  - [x] 4.3 添加剩余时间显示
    - 创建辅助函数计算剩余时间
    - 在表格中显示剩余时间（如"还剩 15 天"）
    - 处理已过期的情况
    - _需求: 6.5_

  - [ ]* 4.4 编写剩余时间计算测试
    - **属性 18: 剩余时间显示准确性**
    - **验证: 需求 6.5**
    - _需求: 6.5_

  - [x] 4.5 集成 BatchActionsBar
    - 根据选中状态显示/隐藏 BatchActionsBar
    - 传递选中的密钥列表
    - _需求: 3.3_

- [x] 5. 编辑 API Key 对话框
  - [x] 5.1 创建 EditKeyDialog 组件
    - 创建 `frontend/src/components/admin/EditKeyDialog.tsx`
    - 显示当前过期时间
    - 提供两种编辑方式：
      - 日期时间选择器（设置新过期时间）
      - 数字输入框（延长小时数）
    - 实现表单验证
    - _需求: 2.2, 2.3_

  - [x] 5.2 实现编辑 API 调用
    - 在 `frontend/src/services/authService.ts` 中添加 `updateApiKey` 方法
    - 调用 `PATCH /api/admin/keys/:key` 接口
    - 处理成功和失败响应
    - _需求: 2.4_

  - [x] 5.3 集成编辑对话框到 Admin 页面
    - 在 Admin 页面中添加 EditKeyDialog
    - 实现编辑按钮点击处理
    - 实现成功后刷新列表
    - 显示成功/失败 Toast 通知
    - _需求: 2.1, 2.5, 2.6_

  - [ ]* 5.4 编写编辑功能测试
    - **属性 2: 编辑对话框内容正确性**
    - **验证: 需求 2.1, 2.2**
    - **属性 3: API Key 更新成功反馈**
    - **验证: 需求 2.5**
    - **属性 4: API Key 更新失败反馈**
    - **验证: 需求 2.6**
    - _需求: 2.1, 2.2, 2.5, 2.6_

- [x] 6. 批量延长对话框
  - [x] 6.1 创建 BatchExtendDialog 组件
    - 创建 `frontend/src/components/admin/BatchExtendDialog.tsx`
    - 显示选中的密钥数量
    - 提供延长小时数输入框
    - 实现表单验证
    - 显示操作进度
    - _需求: 3.6, 3.7_

  - [x] 6.2 实现批量延长 API 调用
    - 在 `frontend/src/services/authService.ts` 中添加 `batchExtendApiKeys` 方法
    - 调用 `POST /api/admin/keys/batch-extend` 接口
    - 处理响应结果
    - _需求: 3.8_

  - [x] 6.3 集成批量延长对话框
    - 在 Admin 页面中添加 BatchExtendDialog
    - 实现批量延长按钮点击处理
    - 显示操作结果（成功/失败数量）
    - 刷新列表
    - _需求: 3.5, 3.9_

  - [ ]* 6.4 编写批量延长功能测试
    - **属性 6: 批量延长更新所有密钥**
    - **验证: 需求 3.8**
    - **属性 7: 批量操作结果统计正确性**
    - **验证: 需求 3.9, 4.9**
    - **属性 19: 有效期延长单调性**
    - **验证: 需求 2.4, 3.8**
    - _需求: 3.8, 3.9_

- [x] 7. 批量创建对话框
  - [x] 7.1 创建 BatchCreateDialog 组件
    - 创建 `frontend/src/components/admin/BatchCreateDialog.tsx`
    - 提供创建数量输入框（1-100）
    - 提供有效期输入框（小时）
    - 提供可选的描述前缀输入框
    - 实现表单验证
    - 显示创建进度
    - _需求: 4.3, 4.4, 4.5_

  - [x] 7.2 实现批量创建 API 调用
    - 在 `frontend/src/services/authService.ts` 中添加 `batchCreateApiKeys` 方法
    - 调用 `POST /api/admin/keys/batch-create` 接口
    - 处理响应结果
    - _需求: 4.6_

  - [x] 7.3 实现结果展示和导出功能
    - 创建结果列表视图
    - 实现 CSV 导出功能
    - 使用 `papaparse` 或类似库生成 CSV
    - 触发文件下载
    - _需求: 4.7, 4.8_

  - [x] 7.4 集成批量创建对话框
    - 在 Admin 页面中添加批量生成按钮
    - 添加 BatchCreateDialog
    - 实现按钮点击处理
    - 显示操作结果
    - 处理错误情况
    - _需求: 4.1, 4.2, 4.9_

  - [ ]* 7.5 编写批量创建功能测试
    - **属性 8: 批量创建数量一致性**
    - **验证: 需求 4.6**
    - **属性 9: 批量创建结果显示完整性**
    - **验证: 需求 4.7**
    - **属性 10: CSV 导出完整性**
    - **验证: 需求 4.8**
    - _需求: 4.6, 4.7, 4.8, 4.9_

- [x] 8. 用户体验优化
  - [x] 8.1 添加加载状态和进度指示器
    - 在所有异步操作中显示加载状态
    - 批量操作显示进度条或 spinner
    - 禁用操作按钮防止重复提交
    - _需求: 6.1, 6.3_

  - [x] 8.2 优化 Toast 通知
    - 确保所有操作都有适当的 Toast 反馈
    - 成功操作显示绿色 Toast
    - 失败操作显示红色 Toast
    - 批量操作显示详细结果
    - _需求: 6.2_

  - [x] 8.3 添加确认对话框
    - 批量操作前显示确认对话框
    - 显示将要影响的密钥数量
    - 提供取消选项
    - _需求: 3.5, 4.2_

  - [ ]* 8.4 编写用户体验测试
    - **属性 15: 批量操作进度显示**
    - **验证: 需求 6.1**
    - **属性 16: 操作完成通知**
    - **验证: 需求 6.2**
    - **属性 17: 批量操作按钮禁用**
    - **验证: 需求 6.3**
    - _需求: 6.1, 6.2, 6.3_

- [x] 9. 检查点 - 功能集成测试
  - 测试完整的编辑流程
  - 测试完整的批量延长流程
  - 测试完整的批量创建流程
  - 测试侧边栏导航
  - 测试移动端响应式布局
  - 确保所有功能正常工作，询问用户是否有问题

- [x] 10. 性能优化和测试
  - [x] 10.1 优化表格渲染性能
    - 使用 React.memo 优化表格行组件
    - 考虑虚拟滚动（如果密钥数量很大）
    - 优化复选框状态管理
    - _需求: 6.4_

  - [x] 10.2 优化批量操作性能
    - 后端使用 goroutine 并发处理
    - 限制并发数量（如 10 个并发）
    - 前端显示实时进度
    - _需求: 6.4_

  - [ ]* 10.3 性能测试
    - 测试批量创建 100 个密钥的性能（< 5秒）
    - 测试批量延长 100 个密钥的性能
    - 测试大量密钥列表的渲染性能
    - _需求: 6.4_

- [x] 11. 集成测试和端到端测试
  - [ ]* 11.1 编写集成测试
    - **属性 11: 管理员权限验证**
    - **验证: 需求 5.4**
    - **属性 12: 批量操作参数验证**
    - **验证: 需求 5.5**
    - **属性 13: 批量操作响应格式**
    - **验证: 需求 5.6**
    - **属性 14: 存储持久化一致性**
    - **验证: 需求 5.7**
    - **属性 20: 批量操作原子性**
    - **验证: 需求 3.8, 4.9**
    - _需求: 5.4, 5.5, 5.6, 5.7_

  - [ ]* 11.2 编写端到端测试
    - 测试管理员登录后的完整工作流
    - 测试侧边栏导航和内容切换
    - 测试批量操作的用户体验
    - 测试移动端响应式布局
    - _需求: 1.1, 1.3, 1.5_

- [x] 12. 最终检查点
  - 运行所有测试确保通过
  - 检查 API 文档是否完整
  - 检查代码质量和注释
  - 测试所有功能在生产环境的表现
  - 确保所有功能正常工作，询问用户是否满意

## 注意事项

- 标记为 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个检查点都应该确保当前阶段的功能完整且测试通过
- 前端组件应该保持与现有 Shadcn/UI 和 Tailwind 风格一致
- 所有错误信息应该使用 Sonner Toast 显示
- API 文档必须使用中文编写并与代码保持同步
- 批量操作应该有适当的性能优化
- 所有新增功能都应该有相应的单元测试和集成测试
